package SEClass;


import java.sql.*;
import java.util.Scanner;

public class SampleJDBC {
    public static void main(String[] args) {
        // Database connection details
        String url = "jdbc:mysql://localhost:3306/school";
        String user = "root";
        String password = "password";
        String driverClass = "com.mysql.cj.jdbc.Driver"; 

        Connection connection = null;
        Statement statement = null;
        ResultSet resultSet = null;
        Scanner scanner = new Scanner(System.in);

        try {
        		Class.forName(driverClass);
            connection = DriverManager.getConnection(url, user, password);
            // --- NEW: User Selection Logic ---
            System.out.println("Select an action:");
            System.out.println("1. View Patients");
            System.out.println("2. View Procedures"); 
            System.out.println("3. View Events");
            System.out.println("4. Add New Patient");
            System.out.print("Enter choice (1-3): ");
            
            int choice = scanner.nextInt();
            String tableName = "";

            switch (choice) {
                case 1: tableName = "patients"; break;
                case 2: tableName = "procedures"; break;  
                case 3: tableName = "events"; 
                System.out.println("Remember: For patient confidentiality, events are not directly linked to patients or procedure!\nYou'll have to go to the patient and check their events individually.\n");
                break;
                case 4:
                    addNewPatient(connection, scanner);
                    break;
                default: 
                    System.out.println("Invalid selection. Defaulting to 'procedures'.");
                    tableName = "procedures";
            }

            String query = "SELECT * FROM " + tableName;

            Class.forName(driverClass);
            connection = DriverManager.getConnection(url, user, password);
            System.out.println("Connected to the database. Querying table: " + tableName + "\n");

            statement = connection.createStatement();
            resultSet = statement.executeQuery(query);
            
            //Get Metadata to understand the table structure
            ResultSetMetaData metaData = resultSet.getMetaData();
            int columnCount = metaData.getColumnCount();
            
            
        	for (int i = 1; i <= columnCount; i++) {
    			System.out.print(metaData.getColumnName(i) + "\t");
    		}
        	System.out.println();
            while (resultSet.next()) {
                String[] patient_info = sql_entry_to_string_array(resultSet);
                format_and_print_entry(tableName, patient_info);
                System.out.println();
            }

        } catch (ClassNotFoundException e) {
            System.err.println("Error loading the JDBC driver: " + e.getMessage());
            e.printStackTrace();
        } catch (SQLException e) {
            System.err.println("Database error: " + e.getMessage());
            e.printStackTrace();
        } finally {
            try {
                if (resultSet != null) resultSet.close();
                if (statement != null) statement.close();
                if (connection != null) connection.close();
                if (scanner != null) scanner.close();
                System.out.println("\nConnection closed.");
            } catch (SQLException e) {
                System.err.println("Error closing resources: " + e.getMessage());
                e.printStackTrace();
            }
        }
    }
    
    public static String[] sql_entry_to_string_array(ResultSet sql_entries) {
    	try {
    	//Get Metadata to understand the table structure
        ResultSetMetaData metaData = sql_entries.getMetaData();
        int columnCount = metaData.getColumnCount();
    	String[] entries = new String[columnCount];
    	for (int i = 1; i <= columnCount; i++) {
            entries[i-1]= sql_entries.getString(i);
        }
    	
		return entries;
    	}
    	catch(SQLException e) {
    		System.err.println("Database error: " + e.getMessage());
    		return null;
    	}
		}
    
    public static void format_and_print_entry(String table_name, String[] entries) {
    	if (table_name == "patients") {
        	//Last Name	First Name	Pronoun	DOB	Address	City	State	Zip	
        	//Insurance provider	Insurance ID	Sex	Gender	Doctor	MRN
    		String patient_name_and_pronouns = entries[1] + " " + entries[0] + " (" + entries[2] + ")";
    		System.out.println(patient_name_and_pronouns);
    		System.out.println("Born: " + entries[3]);
    		System.out.println("Address: " + entries[4] + ", " + entries[5] + " " + entries[6]);
    		System.out.println("Insurance Provider: " + entries[7] + "\n\tID Number: " + entries[8]);
    		System.out.println("Overseen by " + entries[11]);
    	}
    	if (table_name == "procedures") {
    		//Name	Procedure ID	Base Cost	Category
    		System.out.println(entries[0] + "\n\tCost: " + entries[2] + "\n\t(" + entries[3] + ")");
    	}
    	if (table_name == "events") {
    		//MRN	Proc. ID	Date	Time	Doctor	Paid?
    		System.out.println("Date: " + entries[2] + "\t" + entries[3] + 
    				"\n\tMRN: " + entries[0] + "\n\tProcedure ID: " + entries[1] + "\n\tDone by: " + entries[4]
    				+ "\n\tPaid? " + entries[5]
    				);
    		
    		
    	}
    }
}


