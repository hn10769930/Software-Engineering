package SEClass;

import java.sql.*;
import java.util.Scanner;

public class SampleJDBC {
    public static void main(String[] args) {
        // Database connection details
        String url = "jdbc:mysql://localhost:3306/school";
        String user = "root";
        String password = "password";
        String driverClass = "com.mysql.cj.jdbc.Driver"; 

        Connection connection = null;
        Statement statement = null;
        ResultSet resultSet = null;
        Scanner scanner = new Scanner(System.in);

        try {
            Class.forName(driverClass);
            connection = DriverManager.getConnection(url, user, password);

            // --- NEW: User Selection Logic ---
            System.out.println("Select an action:");
            System.out.println("1. View Patients");
            System.out.println("2. View Procedures"); 
            System.out.println("3. View New Events"); 
            // Add new patient option
            System.out.println("4. Add New Patient"); 
            System.out.print("Enter choice (1-4): ");
            
            int choice = scanner.nextInt();
            scanner.nextLine(); // Consume the leftover newline character
            String tableName = "";

            switch (choice) {
                case 1: 
                    viewTable(connection, "patients"); break;
                case 2: 
                    viewTable(connection, "procedures"); break;  
                case 3: 
                    System.out.println("Remember: For patient confidentiality, events are not directly linked to patients or procedure!\nYou'll have to go to the patient and check their events individually.\n");
                    viewTable(connection, "events"); break; 
                case 4:
                    addNewPatient(connection, scanner); break;
                default: 
                    System.out.println("Invalid selection.");
            }

        } catch (ClassNotFoundException e) {
            System.err.println("Error loading the JDBC driver: " + e.getMessage());
            e.printStackTrace();
        } catch (SQLException e) {
            System.err.println("Database error: " + e.getMessage());
            e.printStackTrace();
        } finally {
            try {
                if (resultSet != null) resultSet.close();
                if (statement != null) statement.close();
                if (connection != null) connection.close();
                if (scanner != null) scanner.close();
                System.out.println("\nConnection closed.");
            } catch (SQLException e) {
                System.err.println("Error closing resources: " + e.getMessage());
            }
        }
    }
    
  
    public static void addNewPatient(Connection conn, Scanner scanner) throws SQLException {
        System.out.println("\n--- Adding New Patient ---");
        
        // Gather data
        System.out.print("First Name: ");
        String fName = scanner.nextLine();
        
        System.out.print("Last Name: ");
        String lName = scanner.nextLine();
        
        System.out.print("Pronouns (e.g. He/Him): ");
        String pronouns = scanner.nextLine();
        
        System.out.print("Date of Birth (D/M/YYYY): ");
        String dob = scanner.nextLine();
        
        System.out.print("Address: ");
        String address = scanner.nextLine();
        
        System.out.print("City: ");
        String city = scanner.nextLine();
        
        System.out.print("State: ");
        String state = scanner.nextLine();
        
        System.out.print("Zip: ");
        String zip = scanner.nextLine();
        
        System.out.print("Insurance Provider: ");
        String insProvider = scanner.nextLine();
        
        System.out.print("Insurance ID: ");
        String insID = scanner.nextLine();
        
        System.out.print("Sex: ");
        String sex = scanner.nextLine();
        
        System.out.print("Gender: ");
        String gender = scanner.nextLine();
        
        System.out.print("Doctor Name: ");
        String doctor = scanner.nextLine();
        
        System.out.print("MRN (Medical Record Number): ");
        String mrn = scanner.nextLine();

        //Prepare SQL
        String sql = "INSERT INTO patients (Last Name, First Name, Pronoun, DOB, Address, City, State, Zip, Insurance provider, Insurance ID, Sex, Gender, Doctor, MRN) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
        
        try (PreparedStatement pstmt = conn.prepareStatement(sql)) {
        		pstmt.setString(1, lName);
            pstmt.setString(2, fName);
            pstmt.setString(3, pronouns);
            pstmt.setString(4, dob);
            pstmt.setString(5, address);
            pstmt.setString(6, city);
            pstmt.setString(7, state);
            pstmt.setString(8, zip);
            pstmt.setString(9, insProvider);
            pstmt.setString(10, insID);
            pstmt.setString(11, sex);
            pstmt.setString(12, gender);
            pstmt.setString(13, doctor);
            pstmt.setString(14, mrn);
            
            int rowsInserted = pstmt.executeUpdate();
            if (rowsInserted > 0) {
                System.out.println("A new patient was inserted successfully!");
            }
        }
    }

    // Refactored the viewing logic into its own method to keep Main clean
    public static void viewTable(Connection connection, String tableName) throws SQLException {
        String query = "SELECT * FROM " + tableName;
        System.out.println("Connected to the database. Querying table: " + tableName + "\n");

        Statement statement = connection.createStatement();
        ResultSet resultSet = statement.executeQuery(query);
        
        ResultSetMetaData metaData = resultSet.getMetaData();
        int columnCount = metaData.getColumnCount();
        
        for (int i = 1; i <= columnCount; i++) {
            System.out.print(metaData.getColumnName(i) + "\t");
        }
        System.out.println();
        
        while (resultSet.next()) {
            String[] patient_info = sql_entry_to_string_array(resultSet);
            format_and_print_entry(tableName, patient_info);
            System.out.println();
        }
    }
    
    public static String[] sql_entry_to_string_array(ResultSet sql_entries) {
        try {
        	//Get Metadata to understand the table structure
            ResultSetMetaData metaData = sql_entries.getMetaData();
            int columnCount = metaData.getColumnCount();
            String[] entries = new String[columnCount];
            for (int i = 1; i <= columnCount; i++) {
                entries[i-1]= sql_entries.getString(i);
            }
            
            return entries;
        }
        catch(SQLException e) {
            System.err.println("Database error: " + e.getMessage());
            return null;
        }
    }
    
    public static void format_and_print_entry(String table_name, String[] entries) {
	    	if (table_name == "patients") {
	        	//Last Name	First Name	Pronoun	DOB	Address	City	State	Zip	
	        	//Insurance provider	Insurance ID	Sex	Gender	Doctor	MRN
	    		String patient_name_and_pronouns = entries[1] + " " + entries[0] + " (" + entries[2] + ")";
	    		System.out.println(patient_name_and_pronouns);
	    		System.out.println("Born: " + entries[3]);
	    		System.out.println("Address: " + entries[4] + ", " + entries[5] + " " + entries[6]);
	    		System.out.println("Insurance Provider: " + entries[7] + "\n\tID Number: " + entries[8]);
	    		System.out.println("Overseen by " + entries[11]);
	    	}
	    	if (table_name == "procedures") {
	    		//Name	Procedure ID	Base Cost	Category
	    		System.out.println(entries[0] + "\n\tCost: " + entries[2] + "\n\t(" + entries[3] + ")");
	    	}
	    	if (table_name == "events") {
	    		//MRN	Proc. ID	Date	Time	Doctor	Paid?
	    		System.out.println("Date: " + entries[2] + "\t" + entries[3] + 
	    				"\n\tMRN: " + entries[0] + "\n\tProcedure ID: " + entries[1] + "\n\tDone by: " + entries[4]
	    				+ "\n\tPaid? " + entries[5]
	    				);
	    	}
	}
}